## 从ECMA规范了解JS执行上下文

JavaScript 标准把一段代码（包括函数），执行所需的所有信息定义为：`执行上下文`。

执行上下文在 `ES3` 中，只包含三个部分。

- scope：作用域，也常常被叫做作用域链。
- variable object：变量对象，用于存储当前环境变量的对象。
- this value：`this` 值。

在 `ES5` 中，对命名方式进行了调整，将执行上下文最初的三个部分改为下面这个样子，其他没什么变化。

- lexical environment：词法环境，当获取变量时使用，即上文的静态作用域。
- variable environment：变量环境，当声明变量时使用。
- this value：`this` 值。

在 `ES2018` 中，执行上下文又变成了这个样子，this 值被归入 `lexical environment`，其他增加了不少内容。

- lexical environment：词法环境，当获取变量或者 `this` 值时使用。
- variable environment：变量环境，当声明变量时使用。
- code evaluation state：执行、暂停和恢复与此执行上下文关联的代码的评估所需的任何状态。
- Function：活动函数对象。执行的任务是函数时使用，表示正在被执行的函数。
- ScriptOrModule：执行的任务是脚本或者模块时使用，表示正在被执行的代码。
- Realm：领域 -> 使用的基础库和内置对象实例。
- Generator：仅生成器上下文有这个属性，表示当前生成器。

在最新的 `ES2022` 中，执行上下文增加了一种私有环境 `Private environment`

- 其他同 `ES2018`
- Private environment：私有环境，当前类生成的变量对象，如无则为null

---

通过上述规范，可以发现 `JS执行上下文` 也是在不断完善的。
也就不难理解，网上为什么有这么多 `【深入理解JS上下文】` 的相关文章了，因为这玩意儿确实很抽象，不好描述。

在众多介绍 `JS执行上下文` 的文章的开篇，我们经常可以见到这种说法：

---
执行上下文总共有三种类型：

- 全局执行上下文： 这是默认的、最基础的执行上下文。不在任何函数中的代码都位于全局执行上下文中。它做了两件事：1. 创建一个全局对象，在浏览器中这个全局对象就是 `window` 对象。2. 将 `this` 指针指向这个全局对象。一个程序中只能存在一个全局执行上下文。
- 函数执行上下文： 每次调用函数时，都会为该函数创建一个新的执行上下文。每个函数都拥有自己的执行上下文，但是只有在函数被调用的时候才会被创建。一个程序中可以存在任意数量的函数执行上下文。每当一个新的执行上下文被创建，它都会按照特定的顺序执行一系列步骤，具体过程将在本文后面讨论。
- Eval 函数执行上下文： 运行在 `eval` 函数中的代码也获得了自己的执行上下文，但由于 Javascript 开发人员不常用 `eval` 函数，所以在这里不再讨论。

---

关于 `js执行上下文` 到底有哪些类型，并不是ES规范所约束的。上述那段话，也可以理解成，js的执行场景有三种，当然现在其实已经不止三种了。除了全局作用域（全局上下文），函数作用域（函数上下文），还有比较常见的块级作用域(块级上下文{}, try {} catch，with)...

除此之外，`js执行上下文` 的 `执行`，还分为两个阶段：

- 创建阶段
- 执行阶段

### 创建阶段

- lexical environment：词法环境，当获取变量或者 this 值时使用。

在ES规范中，有明确提到这个阶段发生的一些事情，创建阶段将会生成一个`lexical environment：词法环境`，也就是我们常说的`静态作用域`；
它在规范里是这么描述的，由一个环境记录组成，可以被认为是一个对象，其属性是在相关执行上下文中声明的变量名和函数名。
它还可以链接到外部的词法环境（即其作用域链），因此它用于解析当前执行上下文之外的标识符（例如，函数内的全局变量）。

这就是为什么你能在函数内部，访问到外部变量的原因。

创建阶段，将会遍历代码，找到当前这段代码中的变量和函数名，将其添加到词法环境的属性中。

- variable environment：变量环境，当声明变量时使用。

顺便说下，`变量环境`只是执行上下文中`词法环境`的一部分，本质上只是在当前上下文中声明的变量和函数。

而且从 `ES6` 开始，变量环境通常不包含“变量和函数”。它只包含用 `var` 声明的变量，因为 `let` 和 `const` 使用的是词法环境。

- Private environment：私有环境，当前类生成的变量对象，如无则为null

同变量环境概念类似，属于`词法环境`的一部分，只包含 `class` 生成的私有变量。

`this`的指向，也是在这个阶段发生的，归属于`词法环境`。

### 执行阶段

在这个阶段，前期工作都准备好了，`js` 将会一行行的执行你的代码，如果在这个环境下找不到需要的变量或者参数，就会沿着词法环境往外找。执行完之后，跳出当前执行栈，继续下一段执行上下文。
